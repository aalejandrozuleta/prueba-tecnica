generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

/**
 * Estados posibles de una deuda
 */
enum DebtStatus {
  PENDING
  PAID
}

/**
 * Roles b√°sicos del sistema
 */
enum UserRole {
  USER
  ADMIN
}

//////////////////////////////////////////////////////
// MODELOS
//////////////////////////////////////////////////////

/**
 * Usuario del sistema
 */
model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  name            String?

  role            UserRole  @default(USER)
  isActive        Boolean   @default(true)
  emailVerified   Boolean   @default(false)

  // Auditor√≠a de acceso
  lastLoginAt     DateTime?
  lastLoginIp     String?
  lastUserAgent   String?

  // Auditor√≠a general
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  // Relaciones
  debtsAsDebtor   Debt[]    @relation("Debtor")
  debtsAsCreditor Debt[]    @relation("Creditor")
  
  // üîê Relaciones de autenticaci√≥n
   authSessions    AuthSession[]

  @@map("users")
}

/**
 * Deudas entre usuarios
 */
model Debt {
  id           String      @id @default(uuid())
  amount       Decimal     @db.Decimal(10, 2)
  description  String?

  status       DebtStatus  @default(PENDING)

  debtorId     String
  creditorId   String

  // Auditor√≠a
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  paidAt       DateTime?

  // Relaciones
  debtor       User        @relation("Debtor", fields: [debtorId], references: [id])
  creditor     User        @relation("Creditor", fields: [creditorId], references: [id])
  payments     PaymentHistory[]

  // √çndices
  @@index([debtorId])
  @@index([creditorId])
  @@index([status])

  @@map("debts")
}

/**
 * Historial de pagos (extensible a pagos parciales)
 */
model PaymentHistory {
  id        String   @id @default(uuid())
  debtId    String
  amount    Decimal  @db.Decimal(10, 2)
  paidAt    DateTime @default(now())

  // Relaci√≥n
  debt      Debt     @relation(fields: [debtId], references: [id])

  @@index([debtId])
  @@map("payment_history")
}

//////////////////////////////////////////////////////
// AUTENTICACI√ìN
//////////////////////////////////////////////////////

/**
 * Sesiones activas del usuario
 */
model AuthSession {
  id            String   @id @default(uuid())
  userId        String

  refreshToken  String   // HASHED
  deviceId      String
  ip            String
  userAgent     String

  expiresAt     DateTime
  lastUsedAt    DateTime @default(now())

  createdAt     DateTime @default(now())
  revokedAt     DateTime?

  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([deviceId])
  @@map("auth_sessions")
}

/**
 * Auditor√≠a de intentos de login
 */
model LoginAudit {
  id         String   @id @default(uuid())
  email      String
  ip         String
  userAgent String
  success    Boolean

  createdAt DateTime @default(now())

  @@index([email])
  @@index([ip])
  @@map("login_audit")
}

